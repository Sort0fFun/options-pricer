{% extends "base.html" %}

{% block title %}PnL Predictor - NSE Options Pricer{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="bg-gradient-to-r from-nse-dark to-nse-primary p-6 rounded-lg text-white shadow-lg mb-6">
    <h2 class="text-3xl font-bold">P&L Predictor</h2>
    <p class="mt-2 opacity-90">Analyze profit and loss for options strategies</p>
</div>

<!-- Main Layout -->
<div class="flex flex-col lg:flex-row gap-6">
    <!-- Sidebar -->
    <div class="sidebar">
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-4">Market Parameters</h3>

        <form id="pnl-params-form" class="space-y-4">
            <!-- Current Price -->
            <div>
                <label class="input-label" for="pnl_current_price">Current Price (KES)</label>
                <input type="number" id="pnl_current_price" class="input-field" value="100.0" step="0.1" min="0">
            </div>

            <!-- Price Range -->
            <div>
                <label class="input-label" for="pnl_price_range">Price Range (%)</label>
                <input type="number" id="pnl_price_range" class="input-field" value="50" min="10" max="100">
                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">Range around current price for analysis</p>
            </div>

            <!-- Time to Expiry -->
            <div>
                <label class="input-label" for="pnl_time_expiry">Time to Expiry (years)</label>
                <input type="number" id="pnl_time_expiry" class="input-field" value="0.0822" step="0.001" min="0.001" max="1">
                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">~30 days = 0.0822</p>
            </div>
        </form>
    </div>

    <!-- Main Content with Tabs -->
    <div class="main-content">
        <!-- Tabs -->
        <div class="tab-list">
            <button class="tab-button tab-button-active" data-tab="strategy">Strategy Builder</button>
            <button class="tab-button" data-tab="custom">Custom Position</button>
            <button class="tab-button" data-tab="compare">Compare Strategies</button>
            <button class="tab-button" data-tab="scenario">Scenario Analysis</button>
        </div>

        <!-- Tab 1: Strategy Builder -->
        <div id="tab-strategy" class="tab-content tab-content-active mt-6">
            <div class="card">
                <h3 class="card-header">Pre-Built Strategies</h3>

                <div class="mb-4">
                    <label class="input-label" for="strategy-select">Select Strategy</label>
                    <select id="strategy-select" class="input-field">
                        <option value="">Loading strategies...</option>
                    </select>
                </div>

                <!-- Strategy Parameters (dynamic based on selection) -->
                <div id="strategy-params" class="mb-4 space-y-3"></div>

                <button id="calculate-strategy-btn" class="btn-primary">Calculate P&L</button>

                <!-- Results -->
                <div id="strategy-results" class="mt-6 hidden">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">P&L Diagram</h4>
                    <div id="strategy-chart" class="w-full h-96 mb-6"></div>

                    <!-- Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="metric-card">
                            <div class="metric-label">Max Profit</div>
                            <div class="metric-value text-green-600">KES <span id="strategy-max-profit">0.00</span></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Max Loss</div>
                            <div class="metric-value text-red-600">KES <span id="strategy-max-loss">0.00</span></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Breakeven Points</div>
                            <div class="metric-value text-sm" id="strategy-breakeven">-</div>
                        </div>
                    </div>

                    <div class="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
                        <p class="text-sm text-blue-900 dark:text-blue-300" id="strategy-description"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Custom Position -->
        <div id="tab-custom" class="tab-content mt-6">
            <div class="card">
                <h3 class="card-header">Build Custom Strategy</h3>

                <!-- Add Leg Form -->
                <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Add Leg</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="input-label text-xs">Option Type</label>
                            <select id="custom-option-type" class="input-field text-sm">
                                <option value="call">Call</option>
                                <option value="put">Put</option>
                            </select>
                        </div>
                        <div>
                            <label class="input-label text-xs">Strike Price</label>
                            <input type="number" id="custom-strike" class="input-field text-sm" value="100" step="0.1">
                        </div>
                        <div>
                            <label class="input-label text-xs">Premium</label>
                            <input type="number" id="custom-premium" class="input-field text-sm" value="5" step="0.1">
                        </div>
                        <div>
                            <label class="input-label text-xs">Position</label>
                            <select id="custom-position" class="input-field text-sm">
                                <option value="long">Long</option>
                                <option value="short">Short</option>
                            </select>
                        </div>
                        <div>
                            <label class="input-label text-xs">Quantity</label>
                            <input type="number" id="custom-quantity" class="input-field text-sm" value="1" min="1">
                        </div>
                        <div class="flex items-end">
                            <button id="add-leg-btn" class="btn-primary w-full">Add Leg</button>
                        </div>
                    </div>
                </div>

                <!-- Current Legs Table -->
                <div class="mb-4">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Current Legs</h4>
                    <div id="custom-legs-container">
                        <p class="text-sm text-gray-500">No legs added yet</p>
                    </div>
                </div>

                <button id="calculate-custom-btn" class="btn-primary" disabled>Calculate Custom P&L</button>

                <!-- Results -->
                <div id="custom-results" class="mt-6 hidden">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Custom Strategy P&L</h4>
                    <div id="custom-chart" class="w-full h-96 mb-6"></div>

                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="metric-card">
                            <div class="metric-label">Max Profit</div>
                            <div class="metric-value text-green-600">KES <span id="custom-max-profit">0.00</span></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Max Loss</div>
                            <div class="metric-value text-red-600">KES <span id="custom-max-loss">0.00</span></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Net Cost</div>
                            <div class="metric-value">KES <span id="custom-net-cost">0.00</span></div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-label">Breakeven</div>
                            <div class="metric-value text-sm" id="custom-breakeven">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 3: Compare Strategies -->
        <div id="tab-compare" class="tab-content mt-6">
            <div class="card">
                <h3 class="card-header">Compare Multiple Strategies</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Select up to 4 strategies to compare side by side
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <select id="compare-strategy-1" class="input-field">
                        <option value="">Strategy 1 - Select...</option>
                    </select>
                    <select id="compare-strategy-2" class="input-field">
                        <option value="">Strategy 2 - Select...</option>
                    </select>
                    <select id="compare-strategy-3" class="input-field">
                        <option value="">Strategy 3 - Select...</option>
                    </select>
                    <select id="compare-strategy-4" class="input-field">
                        <option value="">Strategy 4 - Select...</option>
                    </select>
                </div>

                <button id="compare-btn" class="btn-primary">Compare Strategies</button>

                <div id="compare-results" class="mt-6 hidden">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Strategy Comparison</h4>
                    <div id="compare-chart" class="w-full h-96"></div>
                </div>
            </div>
        </div>

        <!-- Tab 4: Scenario Analysis -->
        <div id="tab-scenario" class="tab-content mt-6">
            <div class="card">
                <h3 class="card-header">Scenario Analysis</h3>
                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                    Analyze how volatility and time decay affect strategy performance
                </p>

                <div class="mb-4">
                    <label class="input-label">Select Strategy for Analysis</label>
                    <select id="scenario-strategy" class="input-field">
                        <option value="">Loading...</option>
                    </select>
                </div>

                <button id="scenario-analyze-btn" class="btn-primary">Run Scenario Analysis</button>

                <div id="scenario-results" class="mt-6 hidden">
                    <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">Volatility Impact Analysis</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        Showing P&L under different volatility and time scenarios
                    </p>
                    <div id="scenario-chart" class="w-full h-96"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/components/pnl.js') }}"></script>
{% endblock %}
